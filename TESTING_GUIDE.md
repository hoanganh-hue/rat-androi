# DogeRat Web Admin - Comprehensive Testing Guide

## üìã T·ªïng quan

H∆∞·ªõng d·∫´n n√†y m√¥ t·∫£ chi ti·∫øt c√°ch ch·∫°y v√† th·ª±c hi·ªán testing cho to√†n b·ªô d·ª± √°n DogeRat Web Admin, ƒë·∫£m b·∫£o h·ªá th·ªëng ho·∫°t ƒë·ªông ·ªïn ƒë·ªãnh v·ªõi d·ªØ li·ªáu th·ª±c t·∫ø 100%.

## üéØ M·ª•c ti√™u Testing

1. **Kh√¥ng s·ª≠ d·ª•ng d·ªØ li·ªáu gi·∫£/m√¥ ph·ªèng**: T·∫•t c·∫£ tests ch·∫°y v·ªõi d·ªØ li·ªáu th·ª±c t·ª´ database
2. **Coverage 80%+**: ƒê·∫°t ƒë·ªô ph·ªß code t·ªëi thi·ªÉu 80%
3. **Integration Tests**: Test to√†n b·ªô flow t·ª´ API ƒë·∫øn database
4. **E2E Tests**: Test giao di·ªán ng∆∞·ªùi d√πng v√† t∆∞∆°ng t√°c th·ª±c t·∫ø
5. **Real Device Tests**: Test v·ªõi thi·∫øt b·ªã Android th·∫≠t

## üõ†Ô∏è C√¥ng c·ª• Testing

### Backend Testing
- **Jest**: Test runner v√† assertion framework
- **Supertest**: HTTP API testing
- **PostgreSQL Test DB**: Database ri√™ng cho testing
- **Socket.IO Client**: Test real-time communication

### Frontend Testing  
- **Karma + Jasmine**: Angular testing framework
- **Protractor/Playwright**: E2E testing
- **Chrome Headless**: Browser automation

### CI/CD
- **GitHub Actions**: Automated testing pipeline
- **Docker**: Containerized test environment
- **Codecov**: Coverage reporting

## üì¶ C√†i ƒë·∫∑t

### 1. Setup Test Database

```bash
# T·∫°o database ri√™ng cho testing
createdb -U dogerat dogerat_test

# Ho·∫∑c trong PostgreSQL:
psql -U postgres
CREATE DATABASE dogerat_test;
CREATE USER dogerat WITH PASSWORD 'changeme';
GRANT ALL PRIVILEGES ON DATABASE dogerat_test TO dogerat;
```

### 2. C·∫•u h√¨nh Environment

File `.env.test` ƒë√£ ƒë∆∞·ª£c t·∫°o v·ªõi c·∫•u h√¨nh test:

```bash
# Xem c·∫•u h√¨nh test
cat .env.test
```

### 3. Install Dependencies

```bash
# Backend dependencies
npm install

# Frontend dependencies
cd client && npm install
```

## üß™ Ch·∫°y Tests

### Backend Tests

#### Ch·∫°y t·∫•t c·∫£ tests
```bash
npm test
```

#### Ch·∫°y tests v·ªõi coverage
```bash
npm test -- --coverage
```

#### Ch·∫°y tests c·ª• th·ªÉ
```bash
# Test authentication
npm test -- auth.routes.test

# Test devices API
npm test -- devices.routes.test

# Test screen streaming
npm test -- screen-streaming.test
```

#### Watch mode (t·ª± ƒë·ªông ch·∫°y l·∫°i khi code thay ƒë·ªïi)
```bash
npm run test:watch
```

### Frontend Tests

```bash
cd client

# Run all tests
npm test

# Run with coverage
npm test -- --code-coverage

# Run specific test
ng test --include='**/login.component.spec.ts'

# Run in headless mode (CI)
ng test --watch=false --browsers=ChromeHeadless
```

## üìä Test Coverage

### Xem Coverage Report

Sau khi ch·∫°y tests v·ªõi coverage:

```bash
# Backend coverage
open coverage/lcov-report/index.html

# Frontend coverage
cd client
open coverage/index.html
```

### Coverage Thresholds

D·ª± √°n y√™u c·∫ßu:
- **Statements**: 80%
- **Branches**: 75%
- **Functions**: 80%
- **Lines**: 80%

## üîÑ Integration Tests

### Test API Endpoints v·ªõi Database th·ª±c

```bash
# C√°c tests n√†y t·ª± ƒë·ªông:
# 1. K·∫øt n·ªëi PostgreSQL test database
# 2. Ch·∫°y migrations
# 3. Seed admin user
# 4. Th·ª±c hi·ªán API calls
# 5. Verify k·∫øt qu·∫£ t·ª´ database

npm test -- integration
```

### Test Flow c·ª• th·ªÉ

#### 1. Authentication Flow
```bash
npm test -- auth.routes.test

# Tests:
# ‚úì Register user
# ‚úì Login with credentials
# ‚úì Verify JWT token
# ‚úì Access protected endpoints
# ‚úì Token expiration
```

#### 2. Device Management Flow
```bash
npm test -- devices.routes.test

# Tests:
# ‚úì List devices
# ‚úì Get device details
# ‚úì Send commands to device
# ‚úì Device status updates
# ‚úì Delete device
```

#### 3. Screen Streaming Flow
```bash
npm test -- screen-streaming.test

# Tests:
# ‚úì Start screen stream
# ‚úì Receive frames
# ‚úì Stop stream
# ‚úì Handle errors
```

## üåê E2E Tests

### Setup Playwright

```bash
# Install Playwright
npm install -D @playwright/test
npx playwright install

# Create test directory
mkdir -p e2e
```

### Run E2E Tests

```bash
# Start backend and frontend
docker-compose up -d

# Run E2E tests
npx playwright test

# Run with UI
npx playwright test --ui

# Run specific test
npx playwright test e2e/login.spec.ts
```

### Example E2E Test

```typescript
// e2e/login-to-dashboard.spec.ts
import { test, expect } from '@playwright/test';

test('login and view dashboard', async ({ page }) => {
  // Navigate to login
  await page.goto('http://localhost:4200/login');
  
  // Fill credentials
  await page.fill('input[name="username"]', 'admin');
  await page.fill('input[name="password"]', 'Admin@123456');
  
  // Click login
  await page.click('button[type="submit"]');
  
  // Verify redirect to dashboard
  await expect(page).toHaveURL(/.*dashboard/);
  
  // Verify dashboard content
  await expect(page.locator('h1')).toContainText('Dashboard');
  await expect(page.locator('.device-stats')).toBeVisible();
});
```

## üì± Testing v·ªõi Android Device Th·ª±c

### Setup

1. **C√†i ƒë·∫∑t Android App** tr√™n thi·∫øt b·ªã
2. **Configure connection** ƒë·∫øn server
3. **Run integration tests**

### Test Commands

```bash
# C√°c l·ªánh test v·ªõi device th·∫≠t:

# 1. K·∫øt n·ªëi device
# Device s·∫Ω t·ª± ƒë·ªông k·∫øt n·ªëi khi app kh·ªüi ƒë·ªông

# 2. Test c√°c commands
curl -X POST http://localhost:5000/api/devices/DEVICE_ID/command \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"command": "toast", "params": {"message": "Test"}}'

# 3. Test screen streaming
curl -X POST http://localhost:5000/api/devices/DEVICE_ID/start-screen-stream \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"quality": "medium", "fps": 10}'

# 4. Test remote control
curl -X POST http://localhost:5000/api/devices/DEVICE_ID/inject-touch \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"action": "down", "x": 500, "y": 1000}'
```

## üîç Manual Testing Checklist

### Backend APIs

- [ ] **Authentication**
  - [ ] Login v·ªõi credentials ƒë√∫ng
  - [ ] Login v·ªõi credentials sai
  - [ ] JWT token validation
  - [ ] Token expiration
  - [ ] Logout

- [ ] **Device Management**
  - [ ] List all devices
  - [ ] Filter by status (online/offline)
  - [ ] Get device details
  - [ ] Send command to device
  - [ ] Delete device
  - [ ] Device auto-reconnection

- [ ] **User Management** (Admin only)
  - [ ] Create new user
  - [ ] Update user
  - [ ] Delete user
  - [ ] Change user role
  - [ ] List users with pagination

- [ ] **Audit Trail**
  - [ ] View audit logs
  - [ ] Filter by date range
  - [ ] Filter by user
  - [ ] Filter by action
  - [ ] Export to CSV

- [ ] **File Upload**
  - [ ] Upload file
  - [ ] Download file
  - [ ] Delete file
  - [ ] Size limit validation

### Frontend UI

- [ ] **Login Page**
  - [ ] Form validation
  - [ ] Error messages
  - [ ] Remember me
  - [ ] Redirect after login

- [ ] **Dashboard**
  - [ ] Display statistics
  - [ ] Recent devices list
  - [ ] Real-time updates
  - [ ] Refresh data

- [ ] **Device List**
  - [ ] Display all devices
  - [ ] Status indicators
  - [ ] Search/filter
  - [ ] Pagination
  - [ ] Sorting

- [ ] **Device Detail**
  - [ ] Display device info
  - [ ] Send commands
  - [ ] View command history
  - [ ] View device logs
  - [ ] Real-time status updates

- [ ] **User Management**
  - [ ] Create user (modal)
  - [ ] Edit user
  - [ ] Delete user (confirmation)
  - [ ] Role-based visibility

- [ ] **Audit Trail**
  - [ ] Display logs
  - [ ] Date picker
  - [ ] Export functionality
  - [ ] Pagination

### Real-time Features

- [ ] **Socket.IO Connection**
  - [ ] Auto-connect after login
  - [ ] Auto-reconnect on disconnect
  - [ ] Event handling

- [ ] **Device Status Updates**
  - [ ] Device connected notification
  - [ ] Device disconnected notification
  - [ ] Status change in UI

- [ ] **Command Responses**
  - [ ] Receive command results
  - [ ] Display in UI
  - [ ] Error handling

### Security

- [ ] **Authentication**
  - [ ] Protected routes
  - [ ] Token expiration handling
  - [ ] Unauthorized access denied

- [ ] **Authorization**
  - [ ] Admin-only features hidden from others
  - [ ] API endpoints check roles
  - [ ] Proper error messages

- [ ] **Input Validation**
  - [ ] XSS prevention
  - [ ] SQL injection prevention
  - [ ] File upload validation

- [ ] **Rate Limiting**
  - [ ] API rate limits enforced
  - [ ] 429 status code returned
  - [ ] Proper error messages

## üêõ Debugging Tests

### Backend Tests

```bash
# Run with verbose logging
npm test -- --verbose

# Run single test with debugging
node --inspect-brk node_modules/.bin/jest --runInBand auth.routes.test

# Check database state during tests
psql -U dogerat dogerat_test -c "SELECT * FROM users;"
```

### Frontend Tests

```bash
# Run with debugging
ng test --browsers=Chrome

# Use browser DevTools
# Tests will pause at `debugger;` statements
```

## üìà Continuous Integration

### GitHub Actions

Workflow t·ª± ƒë·ªông ch·∫°y khi:
- Push code l√™n main/develop
- T·∫°o Pull Request

Steps:
1. **Lint & Type Check**: Ki·ªÉm tra code style v√† types
2. **Backend Tests**: Ch·∫°y Jest tests v·ªõi PostgreSQL
3. **Frontend Tests**: Ch·∫°y Karma tests
4. **Build Docker**: Build images n·∫øu tests pass
5. **Security Scan**: Scan vulnerabilities
6. **Deploy**: Deploy n·∫øu ·ªü main branch

### Xem CI Results

```bash
# Visit GitHub Actions tab
https://github.com/hoanganh-hue/rat-androi/actions

# Check status badge
# Add to README.md:
# ![CI Status](https://github.com/hoanganh-hue/rat-androi/workflows/CI/badge.svg)
```

## üöÄ Testing trong Production

### Health Checks

```bash
# Backend health
curl http://localhost:5000/api/health

# Expected response:
{
  "status": "ok",
  "timestamp": "2024-10-21T05:35:52.925Z",
  "database": "connected",
  "uptime": 123456
}
```

### Monitoring

```bash
# View logs
docker-compose logs -f server

# View database connections
docker-compose exec postgres psql -U dogerat -c "SELECT * FROM pg_stat_activity;"

# View resource usage
docker stats
```

### Performance Testing

```bash
# Install Apache Bench
sudo apt-get install apache2-utils

# Test API endpoint
ab -n 1000 -c 10 -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:5000/api/devices

# Test with different payloads
ab -n 100 -c 5 -p data.json -T application/json \
  http://localhost:5000/api/auth/login
```

## üìù Best Practices

1. **S·ª≠ d·ª•ng test database ri√™ng**: Kh√¥ng test tr√™n production/development DB
2. **Clean up sau m·ªói test**: X√≥a test data ƒë·ªÉ tr√°nh conflicts
3. **Test v·ªõi d·ªØ li·ªáu th·ª±c**: Kh√¥ng mock database queries
4. **Test edge cases**: Test c√°c tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát v√† errors
5. **Maintain test data**: Gi·ªØ test data nh·ªè g·ªçn v√† relevant
6. **Document tests**: Th√™m comments gi·∫£i th√≠ch test scenarios
7. **Run tests locally tr∆∞·ªõc khi push**: ƒê·∫£m b·∫£o CI s·∫Ω pass
8. **Review coverage reports**: T√¨m v√† test code ch∆∞a ƒë∆∞·ª£c cover

## üÜò Troubleshooting

### Test Database Connection Failed

```bash
# Check PostgreSQL is running
pg_isready -U dogerat -d dogerat_test

# Reset test database
dropdb dogerat_test
createdb dogerat_test
npm run db:migrate
```

### Tests Timeout

```bash
# Increase timeout in jest.config.js
testTimeout: 30000

# Or per test:
it('should work', async () => {
  // test code
}, 30000);
```

### Port Already in Use

```bash
# Kill process using port
lsof -ti:5000 | xargs kill -9

# Or use different port in .env.test
PORT=5001
```

## üìö T√†i li·ªáu tham kh·∫£o

- [Jest Documentation](https://jestjs.io/docs/getting-started)
- [Supertest Guide](https://github.com/visionmedia/supertest)
- [Angular Testing Guide](https://angular.io/guide/testing)
- [Playwright Documentation](https://playwright.dev/docs/intro)
- [PostgreSQL Testing Best Practices](https://www.postgresql.org/docs/current/regress.html)

---

**L∆∞u √Ω**: T√†i li·ªáu n√†y ƒë∆∞·ª£c c·∫≠p nh·∫≠t li√™n t·ª•c. Vui l√≤ng b√°o c√°o issues ho·∫∑c suggest improvements!
